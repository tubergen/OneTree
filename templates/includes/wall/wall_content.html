{% comment %}

The ajax call to generate this upon new filter only sends posts and group to this 
template. Don't rely on any other template variables being here.

I just wanted to see if I could do Ajax. We can move this stuff out of here later.
Brian: I moved your code elsewhere so I can use inheritance to put it in the head.
{% endcomment %}

<script type="text/javascript" charset="utf-8">

    // unbinds click() on the button specified by function params
    // type should be either the string 'up' or the string 'down'
    // NOTE: this function goes unused and is untested
    function bind_vote(type, post_id, post_type)
    {
        $('#' + type + '-button-' + post_type + '-' + post_id).click('');
    }

    // binds update_vote_script to the button of type type
    // type should be either the string 'up' or the string 'down'
    function bind_vote(type, post_id, post_type)
    {
        $('#' + type + '-button-' + post_type + '-' + post_id).click(function() {
            update_vote_script(type, post_id, post_type);
        });
    }

    // Bind the correct functions to the buttons depending on whether 
    // the user has logged in and voted on this post before
    $(document).ready(function() {
        {% if user.is_authenticated %}
            // make all posts' voting active
            {% for post in posts %}
                bind_vote('up', {{post.id}}, {{post.post_type}});
                bind_vote('down', {{post.id}}, {{post.post_type}});
            {% endfor %}

            // retroactively remove voting from some of them
            {% for post_vote in voted_post_set %}
                var vote = {{ post_vote.vote }};
                var post_id = {{ post_vote.post.id }};
                var post_type = {{post_vote.post.post_type}};

                if (vote == 1)
                {
                    $('#up-button-' + post_type + '-' + post_id).addClass('up-selected');
                }
                else if (vote == 2)
                {
                    $('#down-button-' + post_type + '-' + post_id).addClass('down-selected');
                }
                else 
                {
                }
            {% endfor %}
        {% else %}
            {% for post in posts %}
                $('#down-button-{{post.post_type}}-{{post.id}}').click(function() {
                    alert('Log in to vote !');
                });

                $('#up-button-{{post.post_type}}-{{post.id}}').click(function() {
                    alert('Log in to vote !');
                });
    
            {% endfor %}
        {% endif %}
    });

    // vote_type specifies if this was up or down vote; post_id identifies post
    function update_vote_script(vote_type, post_id, post_type)
    {
        var score_id = '#vote-score-' + post_type + '-' + post_id;
        var old_score = parseInt($(score_id).html());

        var data = {"vote_type":vote_type, "post_id":post_id, "post_type":post_type};

        $.post("/_apps/wall/views-update_vote/", data, function(data) {
            var change = parseInt(data)
            $(score_id).html(old_score + change);

            var up_but = '#up-button-' + post_type + '-' + post_id;
            var down_but = '#down-button-' + post_type + '-' + post_id;
    
            if (vote_type == 'up' && !($(up_but).hasClass('up-selected')))
            {
                $(up_but).addClass('up-selected')
                $(down_but).removeClass('down-selected')
            }
            else if (vote_type == 'down' && !($(down_but).hasClass('down-selected')))
            {
                $(up_but).removeClass('up-selected')
                $(down_but).addClass('down-selected')
            }
            else
            {
                $(up_but).removeClass('up-selected')
                $(down_but).removeClass('down-selected')
            }

        });
    }

    // deletes post specififed by post_id if it's being deleted by the author group
    // otherwise simply removes the post from the wall
    function delete_post(post_id, post_type)
    {
        var data = { "post_id":post_id, "post_type":post_type, "group_id":"{{group.id}}" };
        $.post("{{ delete_post_view_url }}", data, function() {
            $('#post-box-'+post_id).hide();
        });
    }

    // deletes the comment

    function delete_comment(comment_id)
    {
        var data = { "comment_id":comment_id, "group_id":"{{group.id}}" };
        $.post("/_apps/wall/views-delete_comment/", data, function(data) {
            // returned data is the 'post was removed' message
            $('#comment-content-' + comment_id).html(data); 
        });
    }

</script>


<script type="text/javascript" charset="utf-8">
// this code is for posting of comments

// don't hide comments
    function toggle_reply_box(id, reference) {
        if (!reference.is_shown) {
            $('#'+id).show();
            reference.is_shown = true;
        } else {
            $('#'+id).hide();
            reference.is_shown = false;
        }
    }

// make it hidden at first
    $(document).ready(function() { 
      //  $('.comment-post').hide();
       // $('.comment-level-0').show();
        clear_fields(); /* to avoid strange behavior with browser back button */
      });
</script>

{% for post in posts %}
<div class="post-box" id="post-box-{{post.id}}">
    <div class="post-content">
      {% if is_admin or is_newsfeed %}
        <button type="button" class="post-delete delete-button" onClick="delete_post({{post.id}}, {{post.post_type}})"></button>
      {% endif %}
        <div class="post-votes">
            <ul>
                <li>
                    <button type="button" class="up-button" id="up-button-{{post.post_type}}-{{post.id}}"></button></li>
                <li><button type="button" class="down-button" id="down-button-{{post.post_type}}-{{post.id}}"></button></li>
            </ul>
                <span class="vote-score" id="vote-score-{{post.post_type}}-{{post.id}}">{{ post.score }}</span>
        </div>

        <div class="post-group-name">
            {% ifnotequal post.origin_group group %}
                <span class="post-by-child-group">
            {% else %}
                <span class="post-by-same-group">
            {% endifnotequal %}
            {% if post.event_title %}
                 <a href="/group/{{ post.origin_group.url }}">{{ post.origin_group }}</a>: <a class="event-title" href="/group/{{ post.origin_group }}/{{ post.event_url }}/">{{ post.event_title }}</a>
                {% else %}
                    <a href="/group/{{ post.origin_group.url }}">{{ post.origin_group }}</a>
            {% endif %}
            </span>
        </div>
        {% if post.event_date %}
            <p class="event-details">at <span class="event-place">{{ post.event_place }}</span> on <span class="event-date">{{ post.event_date }}</span></p>
            {% if post.flags.all %} <p class="event-flags">{{ post.flags.all|join:", " }}</p>{% endif %}
        {% endif %}

        <div class="post-text">{{ post.text }}</div>
        <div class="post-reply-button">{% if user.is_authenticated %}
            <a onclick="toggle_reply_box('{{ post.post_type }}_id_{{ post.id }}', this);">Comment!</a>
                {% else %}
                <a href="/login/?next={{ request.path }}">Login to comment!</a>
                {% endif %}</div>
    </div>

    {# CHANGE THIS JORGE. CHANGE IT!!!! #}
        {% if user.is_authenticated %}
        {# now allow for posting of comment #}
        <form name="post_{{ post.id }}" id="{{ post.post_type }}_id_{{ post.id }}" class="comment-level-0 comment-post" action="/post/comment/" method="post">{% csrf_token %}
            <input type="hidden" name="next" value="{{ request.path }}"></input>
            <input type="hidden" name="post_id" value="{{ post.id }}"></input>
            <input type="hidden" name="post_type" value="{{ post.post_type }}"></input>
            <label for="comment_text_id_{{ post.id }}" class="comment-label"></label>
            <textarea id="comment_text_id_{{ post.id }}" name="comment_text" onfocus="this.value=''; this.onfocus=null">type comment here!</textarea>
            <input type="submit" value="Post!"></input>
        </form>
        {% endif %}

    {% if post.comment_set.all %}
    <div class="comments-all-div">
        {% for comment in post.comment_set.all reversed %} {# chronological order #}
        <div class="comment comment-level-{{ comment.level }} {% ifequal comment.author user %}comment-is-yours{% endifequal %} {% if forloop.first %}comment-first{% endif %}">
            <span class="comment-author"><a href="/user/{{ comment.author }}">{{ comment.author }}</a></span>
            <span class="comment-content" id="comment-content-{{comment.id}}">{{ comment.text }}</span>
	    {% if is_admin %}
               <button type="button" class="comment-delete delete-button" onClick="delete_comment({{comment.id}})"></button>
            {% endif %}
            <div class="comment-reply-button">
                {% if user.is_authenticated %}
                <a onclick="toggle_reply_box('comment_post_id_{{ comment.id }}', this);">Reply!</a>
                {% else %}
                <a href="/login/?next={{ request.path }}">Login to reply!</a>
                {% endif %}
            </div>
        </div>

        {# posting of a reply to a comment #}
        <form name="comment_post_{{ comment.id }}" id="comment_post_id_{{ comment.id }}" class="comment-post comment-level-1" action="/post/comment/" method="post">{% csrf_token %}
            <input type="hidden" name="next" value="{{ request.path }}"></input>
            <input type="hidden" name="post_id" value="{{ comment.id }}"></input>
            <input type="hidden" name="post_type" value="{{ comment.post_type }}"></input>
            <label for="comment_text_id_{{ comment.id }}" class="comment-label"></label>
            <textarea id="comment_text_id_{{ comment.id }}" name="comment_text" cols="62" rows="2" onfocus="this.value=''; this.onfocus=null">type reply here!</textarea>
            <input type="submit" value="Post!"></input>
        </form>
        {% for comment_child in comment.comment_set.all reversed %} {# chronological order #}
        <div class="comment comment-level-{{ comment_child.level }} {% ifequal comment_child.author user %}comment-is-yours{% endifequal %}">
                <span class="comment-author"><a href="/user/{{ comment_child.author }}">{{ comment_child.author }}</a></span>
                <span class="comment-content" id="comment-content-{{comment_child.id}}">{{ comment_child.text }}</span>
	    {% if is_admin %}
               <button type="button" class="comment-delete delete-button" onClick="delete_comment({{comment_child.id}})"></button>
            {% endif %}
            </div>
        {% endfor %}
        {% if not forloop.last %}
            <hr />
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    {# DO IT #}
</div>
{% endfor %}
